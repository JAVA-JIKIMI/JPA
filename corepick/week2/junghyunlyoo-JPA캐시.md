# JPA 캐시

DB에 접근하여 데이터를 조회하는 것은 WAS 메모리에 접근하여 데이터를 조회하는 것보다 훨씬 많은 비용이 발생한다.

따라서 Mybatis나 JPA같은 DB 프레임워크는 캐시 기능을 제공한다. (Mybatis->Local cache, JPA->1차 2차 캐시 등)

아래는 JPA의 캐시를 설명한다.

## 1차 캐시(영속성 컨텍스트)
- 한 트랜잭션이 시작해서 끝날때까지, 영속성 컨텍스트에 로딩된 객체를 사용할 수 있다. (OSVI 범위까지도 적용 가능)
- 트랜잭션을 커밋하거나 플러시를 호출하면 1차 캐시에 있는 엔티티의 변경 내역을 DB에 동기화한다.
- disable 옵션이 없다. (무조건 동작)
- 1차 캐시 내의 엔티티를 조회하면 이 엔티티가 '그대로' 반환된다. (동시 수정 문제 발생 가능)
- 트랜잭션 단위로 동작하는 기능이기 때문에 애플리케이션 전체 범위에선 캐시로써 효력을 발휘하지 못한다는 한계가 있다.

## 2차 캐시(공유 캐시)

![image](https://user-images.githubusercontent.com/47667821/148594893-044ddecd-fee1-4845-a4ee-7281acc0f0b9.png)

- 트랜잭션 단위로 동작하는 1차 캐시의 한계를 극복한 캐시이다. 
- 어플리케이션 단위로 동작하기 때문에 어플리케이션을 종료할 때까지 캐시가 유지된다.
- 2차 캐시 내의 엔티티를 조회하면 이 엔티티가 '그대로' 반환되지 않고 복사본이 만들어져 반환된다. (동시 수정 문제 발생 불가능)
- 그런데 2차 캐시는 설정이 복잡하고 지원하는 라이브러리도 작다. 더군다나 Spring은 서비스 계층에서 사용할 수 있는 효율적인 캐시를 지원하기 때문에 JPA의 2차 캐시를 사용하는 것보다 다른 캐시를 사용하는 것이 나을 수 있다. ([인프런 질문](https://www.inflearn.com/questions/33629))
